---
title: "Institutions of Higher Education in Germany"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Institutions of Higher Education in Germany}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}

# https://www.w3schools.com/css/css_rwd_viewport.asp
# https://pkgdown.r-lib.org/reference/build_articles.html
# https://stackoverflow.com/questions/34906002/increase-width-of-entire-html-rmarkdown-output

# https://r-pkgs.org/vignettes.html
# https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management
# https://pkgdown.r-lib.org/articles/linking.html

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## The *Hochschulen* Table

```{r}
library(studentenstatistikNRW)
library(tibble)

hochschulen
```

## Interactive HTML Table created with `gt` Package

```{r gt-vars, echo = FALSE}

title <- "Institutions of Higher Education in Germany"
subtitle <- "Sub"
source_note_link <- "https://richardmeyer-eppler.github.io/studentenstatistikNRW"
source_note <- glue::glue(
  "<a href = {source_note_link}>{source_note_link}</a>"
)
max_rows <- nrow(hochschulen)
#max_rows <- 5
table_width <- 1200L
university_logo_height <- 45L

org_urls <- list(
  eu_pic = "https://ec.europa.eu/info/funding-tenders/opportunities/portal/screen/how-to-participate/participant-register",
  gepris = "https://gepris.dfg.de/gepris/OCTOPUS?language=en",
  gerit = "https://gerit.org/en/",
  hrk = "https://www.hochschulkompass.de/en/higher-education-institutions/downloads.html",
  ror = "https://ror.org",
  whed = "https://www.whed.net",
  risis = "https://register.orgreg.joanneum.at"
)

ort_urls <- list(
  daad_cities = "https://www.study-in-germany.de/en/germany/cities/",
  daad_che_cities = "https://www.daad.de/en/studying-in-germany/universities/che-ranking/?che-a=universities-and-towns"
)
```


```{r relevant-fa-icons, echo = FALSE}
pattern <- c(
  "facebook",
  "instagram",
  "mastodon",
  "x-twitter",
  "youtube"
) |> 
  stringr::str_flatten(
    collapse = "|"
  )

neg_pattern <- c(
  "square",
  "facebook-f",
  "facebook-messenger"
) |> 
  stringr::str_flatten(
    collapse = "|"
  )

fa_icons <- fontawesome::fa_metadata()[["icon_names_full_fab"]] |> 
  stringr::str_subset(
    pattern = pattern
  ) |> 
  stringr::str_subset(
    pattern = neg_pattern,
    negate = TRUE
  )
```


```{r fa-icon-functions, echo = FALSE}
fa_icon <- function(name, height = "1.1em", fill = "#333333") {
  fontawesome::fa(
    name = name,
    fill = fill,
    height = height
  ) |> 
  as.character() |> 
  gt::html()
}

social_media_icons <- function(...) {
  
  dots <- rlang::list2(...)
  
  if (
    length(dots) > 0 && !rlang::is_named(dots)
  ) {
    cli::cli_abort("All elements of {.arg ...} must be named.")
  }
  
  names <- names(dots)
  
  dots_not_na <- !is.na(dots)
  
  fa_icons <- purrr::map(
    names,
    fa_icon
  )
  
  fa_icons_with_link <- purrr::map2(
    fa_icons[dots_not_na], 
    dots[dots_not_na],
    \(x, y) htmltools::a(
      x,
      title = y,
      href = y,
      target = "_blank"
    )
  )
  
  div <- htmltools::div(
    title = "Social Media Icons",
    role = "img",
    fa_icons_with_link
  )
  
  div_out <- as.character(div) |> 
    gt::html()
  
  return(div_out)
}

# tibble::tribble(
#   ~facebook, ~instagram,
#  "https://www.facebook.com/unikassel", "https://www.instagram.com/unikassel",
#   NA, "https://www.instagram.com/unikassel"
# ) |>
#   dplyr::rowwise() |>
#   dplyr::mutate(
#     social_media = list(
#       social_media_icons(
#         "fab fa-facebook" = facebook,
#         "fab fa-instagram" = instagram
#       )
#     )
#   ) |>
#   dplyr::ungroup() |>
#   gt::gt()

```


```{r gt-functions, echo = FALSE}

# https://www.w3schools.com/tags/tag_summary.asp
# https://themockup.blog/posts/2020-10-31-embedding-custom-features-in-gt-tables/

label_socal_media <- function(x) {
  label <- dplyr::case_when(
    stringr::str_detect(
      x,
      pattern = "x\\.com"
    ) ~ "x",
    stringr::str_detect(
      x,
      pattern = "facebook"
    ) ~ "fb",
    stringr::str_detect(
      x,
      pattern = "youtube"
    ) ~ "yt",
    stringr::str_detect(
      x,
      pattern = "instagram"
    ) ~ "insta",
    stringr::str_detect(
      x,
      pattern = "instagram"
    ) ~ "insta",
    stringr::str_detect(
      x,
      pattern = "p=4033"
    ) ~ "mastodon",
    .default = NA_character_
  )
  
  return(label)
}

label_ranking <- function(x) {
  label <- dplyr::case_when(
    stringr::str_detect(
      x,
      pattern = "umultirank"
    ) ~ "umultirank",
    stringr::str_detect(
      x,
      pattern = "daad"
    ) ~ "che",
    stringr::str_detect(
      x,
      pattern = "timeshighereducation"
    ) ~ "the",
    stringr::str_detect(
      x,
      pattern = "shanghairanking"
    ) ~ "arwu",
    stringr::str_detect(
      x,
      pattern = "topuniversities"
    ) ~ "qs",
    .default = NA_character_
  )
  
  return(label)
}

create_span <- function(string, label) {
    
  # background-color: rgba(255, 0, 0, 0.5)
  if(is.na(string)) {
    span <- glue::glue(
      '<span style="white-space: pre;"><a" target="_blank" style="color:rgba(0, 0, 0);display: inline-block;">{label}</a></span>'
    )
  } else {
    span <- glue::glue(
      '<span style="white-space: pre;"><a href="{string}" target="_blank" style="color:#008B8B;text-decoration:underline;text-underline-position: under;display: inline-block;">{label}</a></span>'
    )
  }

  return(span)
}

build_wiki_span <- function(urls, labels) {
  
  wiki_span <- purrr::map2(
    urls,
    labels,
    create_span
  ) |> 
    purrr::discard(
      is.na
    ) |> 
    purrr::list_c() |> 
    stringr::str_flatten(
      collapse = " "
    )
  
  return(wiki_span)
}

img_path <- function(logo_url) {
  
  logo_url_decoded <- URLdecode(logo_url)
  
  img_path <- fs::path(
    here::here(),
    fs::path_sanitize(
      fs::path_file(
        logo_url_decoded
      )
    )
  )
  
  return(img_path)
}

build_logo_html <- function(logo_url, hochschule_url, height = university_logo_height) {
  # https://www.w3schools.com/html/html_images.asp
  # https://www.smashingmagazine.com/2020/03/setting-height-width-images-important-again/
  # https://www.w3schools.com/tags/att_img_height.asp
  
  # stringi::stri_unescape_unicode(
  #   gsub("%", paste0("\\", "u00"), logo_url_written[16], fixed = T)
  # )
  # hochsch
  #       logo_url = logo_url,
  #     hochschule_url = url
  # URLdecode(logo_url_written[16])
  # 
  
  img_path <- if(
    is.na(logo_url)
  ) {
    img_path <- gt::test_image()
  } else {
    img_path <- img_path(logo_url)
  }
  
  hochschule_url_na <- ifelse(
    is.na(hochschule_url),
    "#0",
    hochschule_url
  )
  
  img_tag <- gt::local_image(
    filename = img_path,
    height = height
  )
  
  file_ext <- tolower(
    dplyr::coalesce(
      fs::path_ext(NA_character_),
      ""
    )
  )
  
  if(file_ext == "svg") {
    img_tag <- htmltools::a(
      href = hochschule_url_na,
      target = "_blank",
      htmltools::img(
        src = logo_url
      )
    )
    
    img_tag_gt <- img_tag |> 
      as.character() |> 
      gt::html()
    
    return(img_tag_gt)
  }
    
  img_tag_wrangled <- img_tag |> 
    stringr::str_replace(
       pattern = glue::glue(
         'style=\\"height:{height}px;\\">'
        ),
       replacement = glue::glue(
         'style=\\"height:{height}px;border:0px none;\\"</a>'
       )
    )
  
  html <- glue::glue(
    '<a href="{hochschule_url_na}" target="_blank"> {img_tag_wrangled}'
  )
  
  return(html)
}

write_img <- function(logo_url, height = university_logo_height) {
  
  if(is.na(logo_url)) {return(fs::path(NA))}
  
  img_path <- img_path(logo_url)
  img_ext <- tolower(
    fs::path_ext(
      img_path
    )
  )
  
  if(img_ext == "svg") {
    download.file(
      url = URLdecode(logo_url),
      destfile = img_path,
      quiet = TRUE,
      cacheOK = TRUE,
      method = "libcurl"
    )
    
    return(img_path)
  }
  
  if(img_ext == "svg") {
    img <- magick::image_read_svg(
      logo_url
    )
  } else {
    img <- magick::image_read(
      logo_url
    )
  }

  img_trimmed <- magick::image_trim(
    img
  )

  img_resized <- magick::image_resize(
    img_trimmed,
    paste0(
      "x",
      height,
      ">"
    )
  )
  
  magick::image_write(
    img_resized,
    img_path
  )
  
  return(img_path)
}

```

```{r write-images, echo = FALSE}

logo_url <- hochschulen[c(1:max_rows),] |>
    col_to_url(
      dplyr::everything()
    ) |>
    dplyr::mutate(
      logo_url = dplyr::case_when(
        tolower(
          fs::path_ext(
            Wiki_Logo_DE_URL
          )
        ) == "svg" ~ Wiki_Logo_DE_URL,
        .default = Wiki_Logo_DE_Thumbnail_URL
      )
    ) |> 
    dplyr::pull(
      logo_url
   )

# Using purrr shouldn't be necessary because Magick functions are vectorized, but I kept getting errors
# purrr::map_chr(logo_url, write_img)

write_img_safely <- purrr::safely(
  write_img
)

#debugonce(write_img)

list_logo_url_written <- purrr::map(
  #"https://upload.wikimedia.org/wikipedia/commons/e/e5/Ebc-hochschule-logo.jpg",
  logo_url,
  write_img_safely
  #logo_url[540],
  #write_img
)

logo_url_written <- list_logo_url_written |> 
  purrr::map(
    "result"
  ) |> 
  purrr::list_c()

```


```{r id-functions, echo = FALSE}

id_function <- function(label, ...) {
  dots <- rlang::list2(...)
  
  nas <- purrr::map_chr(
    dots,
    "org_id_label"
  ) |> 
    is.na()
  
  # If all IDs are NA return just the label
  if(
    length(
      dots[!nas]
    ) == 0
  ) {
    return(label)
  }
  
  create_table_row <- function(
    list, 
    a_style = "color:#008B8B;text-decoration:underline;text-underline-position: under;display:inline-block;"
  ) {
    org_url <- list$org_url
    org_label <- list$org_label
    org_id_url <- list$org_id_url
    org_id_label <- list$org_id_label
    
    # Inherits from div.rt-td-inner min-width: 100px; width: 100px;
    
    html <- htmltools::tags$tr(
      style = "min-width:200px",
      htmltools::tags$td(
        htmltools::tags$a(
          href = org_url,
          style = a_style,
          target = "_blank",
          org_label
        )
      ),
      htmltools::tags$td(
        htmltools::tags$a(
          href = org_id_url,
          style = a_style,
          target = "_blank",
          org_id_label
        )
      )
    )
  }
  
  list_table_rows <- purrr::map(
    dots[!nas],
    create_table_row
  )
  
  table_out <- htmltools::tags$details(
    htmltools::tags$summary(
      label
    ),
    htmltools::tags$table(
      list_table_rows
    )
  ) |> 
  as.character() |> 
  gt::html()
  
  return(table_out)
}

```


```{r rankings, echo = FALSE}
rankings_html <- function(...) {
  
  dots <- rlang::list2(...)
  dots_not_na <- !is.na(dots)

  labels <- purrr::map_chr(
    dots[dots_not_na],
    label_ranking
  )
  
  # Could do this in css
  # https://css-tricks.com/how-to-add-commas-between-a-list-of-items-dynamically-with-css/
  # https://blog.union.io/code/2018/03/07/add-commas-with-css/
  labels_with_comma <- dplyr::case_when(
    labels != labels[length(labels)] ~ paste0(
      labels,
      ","
    ),
    .default = labels
  )
  
  create_span <- function(
    url, 
    url_label,
    a_style = "color:#008B8B;text-decoration:underline;text-underline-position: under;"
  ) {
    
     html <- htmltools::span(
      #style = "white-space: pre;",
      htmltools::a(
        {url_label},
        href = url,
        target = "_blank",
        style = a_style
      )
    )
     
     return(html)
  }
  
  list_spans <- purrr::map2(
    dots[dots_not_na],
    labels_with_comma,
    create_span
  ) |> 
    htmltools::tagList()
  
  spans_out <- list_spans |> 
    as.character() |> 
    gt::html()
  
  return(spans_out)
}

#debugonce(label_socal_media)
#debugonce(rankings_html)

# tibble::tribble(
#   ~umultirank, ~the,
#   "https://www.umultirank.org/study-at/university-of-kassel-rankings/", "https://www.timeshighereducation.com/world-university-rankings/university-kassel"
# ) |>
#   dplyr::rowwise() |>
#   dplyr::mutate(
#     rankings = rankings_html(
#         umultirank,
#         the
#     )
#   ) |>
#   dplyr::ungroup() |>
#   dplyr::mutate(
#     rankings = purrr::map(
#       rankings,
#       gt::html
#     )
#   ) |>
#  gt::gt()
```



```{r, echo = FALSE}

hochschulen[c(1:max_rows),] |> 
  dplyr::mutate(
    gerit_id = gepris_id
  ) |> 
  col_to_url(
    dplyr::everything()
  ) |>
  dplyr::mutate(
    gepris_id_orig = hochschulen[["gepris_id"]][1:max_rows],
    gerit_id_orig = hochschulen[["gepris_id"]][1:max_rows],
    eu_pic_orig = hochschulen[["eu_pic"]][1:max_rows],
    hs_nr_orig = `[[`(hochschulen, "Hs-Nr.")[1:max_rows],
    ror_id_orig = hochschulen[["ROR_ID"]][1:max_rows],
    risis_orgreg_entity_id_orig = hochschulen[["RISIS_ORGREG_ENTITY_ID"]][1:max_rows],
    whed_id_orig = hochschulen[["WHED_ID"]][1:max_rows],
    DAAD_ORT_LABEL = dplyr::if_else(
      is.na(DAAD_ORT),
      NA,
      Ort
    ),
    CHE_DAAD_Town_ID_Label = dplyr::if_else(
      is.na(CHE_DAAD_Town_ID),
      NA,
      Ort
    ),
    logo_url = logo_url_written
  ) |> 
  dplyr::rowwise() |>
  dplyr::mutate(
    IDs = list(
      id_function(
        label = Hochschulart_Hochschule_Signatur,
        list(
          org_url = org_urls[["eu_pic"]],
          org_label = 'EU PIC',
          org_id_url = eu_pic,
          org_id_label = eu_pic_orig
        ),
        list(
          org_url = org_urls[["gepris"]],
          org_label = 'GEPRIS',
          org_id_url = gepris_id,
          org_id_label = gepris_id_orig
        ),
        list(
          org_url = org_urls[["gerit"]],
          org_label = 'GERiT',
          org_id_url = gerit_id,
          org_id_label = gerit_id_orig
        ),
        list(
          org_url = org_urls[["hrk"]],
          org_label = 'HRK',
          org_id_url = `Hs-Nr.`,
          org_id_label = hs_nr_orig
        ),
        list(
          org_url = org_urls[["risis"]],
          org_label = 'RISIS',
          org_id_url = RISIS_ORGREG_ENTITY_ID,
          org_id_label = risis_orgreg_entity_id_orig
        ),
        list(
          org_url = org_urls[["ror"]],
          org_label = 'ROR',
          org_id_url = ROR_ID,
          org_id_label = ror_id_orig
        ),
        list(
          org_url = org_urls[["whed"]],
          org_label = 'WHED',
          org_id_url = WHED_ID,
          org_id_label = whed_id_orig
        )
      )
    ),
    Ort = list(
      id_function(
        label = Ort,
        list(
          org_url = ort_urls[["daad_cities"]],
          org_label = 'DAAD',
          org_id_url = DAAD_ORT,
          org_id_label = DAAD_ORT_LABEL
        ),
        list(
          org_url = ort_urls[["daad_che_cities"]],
          org_label = 'DAAD CHE',
          org_id_url = CHE_DAAD_Town_ID,
          org_id_label = CHE_DAAD_Town_ID_Label
        )
      )
    ),
    Wiki = build_wiki_span(
      urls = c(
        Wiki_ID_DE,
        Wiki_ID_EN,
        Wikidata_ID
      ),
      labels = c(
        'de',
        'en',
        'data'
      )
    ),
    Logo = build_logo_html(
      logo_url = logo_url,
      hochschule_url = url
    ),
    social_media = list(
      social_media_icons(
        "fab fa-facebook" = facebook_id, 
        "fab fa-instagram" = insta_id,
        "fab fa-mastodon" = mastodon_id,
        "fab fa-x-twitter" = x_user,
        "fab fa-youtube" = youtube_channel_id,
      )
    ),
    Rankings = list(
      rankings_html(
        arwu_id,
        CHE_DAAD_University_ID,
        Multirank,
        the_id,
        qs_world_id
      )
    )
  ) |>
  dplyr::ungroup() |> 
  dplyr::mutate(
    Logo = purrr::map(
      Logo,
      gt::html
    ),
    Wiki = purrr::map(
      Wiki,
      gt::html
    ),
    Rankings = purrr::map(
      Rankings,
      gt::html
    )
  ) |> 
  dplyr::select(
    Logo,
    IDs,
    Ort,
    Hochschule_EN,
    Wiki,
    Rankings,
    social_media
  ) |> 
  gt::gt(
    id = "hochschulen"
    # rowname_col = "Hochschule_Signatur",
    # rownames_to_stub	= TRUE
  ) |>
  gt::tab_header(
    title = title,
    subtitle = subtitle
  ) |> 
  gt::tab_source_note(
    source_note = gt::html(
      source_note
    )
  ) |> 
  gt::cols_label(
    Hochschule_EN = "Hochschule",
    social_media = "Social Media"
  ) |> 
  gt::cols_align(
    align = "left",
    columns = dplyr::everything()
  ) |> 
  gt::cols_align(
    align = "right",
    columns = Logo
  ) |>
  gt::cols_width(
    Logo ~ gt::px(
      325L
    ),
    IDs ~ gt::px(
      150L
    )
  ) |> 
  gt::opt_interactive(
    #use_search = TRUE, # not really useful with so many columns having multiple values
    use_highlight = TRUE,
    use_page_size_select = TRUE,
    page_size_default = 50
  ) |> 
  gt::tab_style(
    style = gt::cell_text(
      align = "left"
    ),
    locations = gt::cells_body(
      columns = c(
        IDs, Ort
      )
    )
  ) |> 
  gt::tab_options(
    container.width = gt::px(table_width),
    table.width = gt::px(table_width)
  ) |> 
  gt::opt_css(
    css = "
    #hochschulen rt-td{
      flex-wrap:wrap;
      align-items:center;
    }
    #hochschulen .rt-align-left{
      align-items:center;
    }
    #hochschulen .rt-align-right{
      align-items:center;
    }
    "
  )

```

As of March 13, 2024, the Federal Statistical Office of Germany (Destatis) lists a total of 427 institutions of higher education in the country. In this vignette, we will use this official data source as basis and go through considerable efforts to complement this data with other sources. In particular:

<style type="text/css">
.container template-article{
  max-width: 1500px !important;
}
</style>

-   We will download all key tables for the student statistics (table series 372) provided by the Federal Statistical Agency ([Destatis](https://www.destatis.de/EN)) on its data collection portal ([Erhebungsportal](https://erhebungsportal.estatistik.de/Erhebungsportal/informationen/statistik-der-studenten-372)). There are four key tables / csv files containing data on institutions of higher education in Germany: 1.) Hochschule, 2.) HochschulStandort, 3.) HochschuleErsteinschreibung, and 4.) HochschulFachbereich, each with slight differences in how and where institutions are counted (e.g. when a university has subsidiary campuses in other cities and German states),

-   we will then match the Destatis data with the [list of all institutions of higher education in Germany](https://www.hochschulkompass.de/hochschulen/downloads.html) provided by the [German Rector's Conference (HRK)](https://www.hrk.de/home/). The Federal Statistical Agency data together with the HRK list are the "most authoritative German numbers" that exist.

-   As described in `vignette("ror")`, we use the global Research Organization Registry (ROR) REST API to retrieve additional data and identifiers which are then matched to the existing data.

This is the exhaustive list of additional data sources that are linked up:

-   links to the German and English Wikipedia article for each institution,

-   links to the Wikidata entry for each institution and a separate link to each institution's German logo, if available,

-   the link to each institution on [studieren.de](https://studieren.de/),

-   the link to the [CHE University Ranking](https://www.daad.de/en/studying-in-germany/universities/che-ranking/) for each institution hosted by the German Academic Exchange Service in English,

-   the link for each institution's [multirank for 2022-2023](https://www.umultirank.org/),

```{r cleanup-images}

fs::file_delete(
  unique(logo_url_written[!is.na(logo_url_written)])
)

```

