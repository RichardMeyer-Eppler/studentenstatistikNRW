---
title: "Institutions of Higher Education in Germany"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Institutions of Higher Education in Germany}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

As of March 13, 2024, the Federal Statistical Office of Germany (Destatis) lists a total of 427 institutions of higher education in the country. In this vignette, we will use this official data source as basis and go through considerable efforts to complement this data with other sources. In particular:

-   We will download all key tables for the student statistics (table series 372) provided by the Federal Statistical Agency ([Destatis](https://www.destatis.de/EN)) on its data collection portal ([Erhebungsportal](https://erhebungsportal.estatistik.de/Erhebungsportal/informationen/statistik-der-studenten-372)). There are four key tables / csv files containing data on institutions of higher education in Germany: 1.) Hochschule, 2.) HochschulStandort, 3.) HochschuleErsteinschreibung, and 4.) HochschulFachbereich, each with slight differences in how and where institutions are counted (e.g. when a university has subsidiary campuses in other cities and German states),

-   we will then match the Destatis data with the [list of all institutions of higher education in Germany](https://www.hochschulkompass.de/hochschulen/downloads.html) provided by the [German Rector's Conference (HRK)](https://www.hrk.de/home/). The Federal Statistical Agency data together with the HRK list are the "most authoritative German numbers" that exist.

-   As described in the [separate vignette on the global Research Organization Registry (ROR)](ror.html), we use the ROR REST API to retrieve additional data and identifiers which are then matched to the existing data.

This is the exhaustive list of additional data sources that are linked up:

-   links to the German and English Wikipedia article for each institution,

-   links to the Wikidata entry for each institution and a separate link to each institution's German logo, if available,

-   the link to each institution on [studieren.de](https://studieren.de/),

-   the link to the [CHE University Ranking](https://www.daad.de/en/studying-in-germany/universities/che-ranking/) for each institution hosted by the German Academic Exchange Service in English,

-   the link for each institution's [multirank for 2022-2023](https://www.umultirank.org/),

## The *Hochschulen* Table

```{r}
library(studentenstatistikNRW)
library(tibble)

hochschulen
```

## Interactive HTML Table created with `gt` Package

```{r, echo = FALSE}

title <- "Institutions of Higher Education in Germany"
subtitle <- "Sub"
source_note_link <- "https://richardmeyer-eppler.github.io/studentenstatistikNRW"
source_note <- glue::glue(
  "<a href = {source_note_link}>{source_note_link}</a>"
)

# https://www.w3schools.com/tags/tag_summary.asp
# https://themockup.blog/posts/2020-10-31-embedding-custom-features-in-gt-tables/

label_socal_media <- function(x) {
  label <- dplyr::case_when(
    stringr::str_detect(
      x,
      pattern = "x\\.com"
    ) ~ "x",
    stringr::str_detect(
      x,
      pattern = "facebook"
    ) ~ "fb",
    stringr::str_detect(
      x,
      pattern = "youtube"
    ) ~ "yt",
    stringr::str_detect(
      x,
      pattern = "instagram"
    ) ~ "insta",
    stringr::str_detect(
      x,
      pattern = "instagram"
    ) ~ "insta",
    stringr::str_detect(
      x,
      pattern = "p=4033"
    ) ~ "mastodon",
    .default = NA_character_
  )
  
  return(label)
}

hochschulen |> 
  col_to_url(
    dplyr::everything()
  ) |>
  dplyr::mutate(
    IDs = glue::glue(
      "<details><summary>{Hochschule_Signatur}</summary><div>Hs-Nr.  {`Hs-Nr.`}</div><div>{STUDIEREN_KEY}</div></details>",
      .na = ""
    ),
    IDs = purrr::map(
      IDs,
      gt::html
    )
  ) |> 
  dplyr::select(
    Logo = Wiki_Logo_DE_Thumbnail_URL,
    IDs,
    Ort,
    CHE_DAAD_Town_ID,
    Hochschule_EN,
    Wikipedia = Wiki_ID_DE,
    Wiki_EN = Wiki_ID_EN,
    Wikidata = Wikidata_ID,
    Ranking = Multirank,
    CHE_DAAD_University_ID,
    the_id,
    arwu_id,
    qs_world_id,
    social_media_x = x_user,
    social_media_facebook = facebook_id,
    social_media_youtube = youtube_channel_id,
    social_media_insta = insta_id,
    social_media_mastodon = mastodon_id
  ) |> 
  gt::gt(
    # rowname_col = "Hochschule_Signatur",
    # rownames_to_stub	= TRUE
  ) |>
  gt::tab_header(
    title = title,
    subtitle = subtitle
  ) |> 
  gt::tab_source_note(
    source_note = gt::html(
      source_note
    )
  ) |> 
  gt::fmt_url(
    columns = Wikipedia,
    label = "de"
  ) |> 
  gt::fmt_url(
    columns = Wiki_EN,
    label = "en"
  ) |> 
  gt::fmt_url(
    columns = Wikidata,
    label = "data"
  ) |> 
  gt::fmt_url(
    columns = dplyr::starts_with(
      "social_media"
    ),
    label = \(x) label_socal_media(x)
  ) |>
  gt::fmt_url(
    columns = Ranking,
    label = "Multirank"
  ) |>
  gt::fmt_url(
    columns = starts_with(
      "CHE_DAAD"
    ),
    label = "CHE-DAAD"
  ) |>
  gt::cols_merge(
    dplyr::starts_with(
      "Wiki"
    ),
    pattern = "{1}, {2}, {3}"
  ) |>
  gt::cols_merge(
    c(
      Ort,
      CHE_DAAD_Town_ID
    ),
    pattern = "{1} ({2})"
  ) |>
  gt::cols_merge(
    c(
      Ranking,
      CHE_DAAD_University_ID
    ),
    pattern = "{1}, {2}"
  ) |>
  gt::cols_merge(
    dplyr::starts_with(
      "social_media"
    )
  ) |> 
  gtExtras::gt_img_rows(
    columns = Logo,
    img_source = "web"
  ) |> 
  # Inserts <br> for no reason!?
  # gt::sub_missing(
  #   missing_text = " "
  # ) |>
  gt::cols_align(
    align = "left",
    columns = c(
      IDs,
      Hochschule_EN,
      Ort
    )
  ) |> 
  gt::opt_interactive(
    use_search = TRUE,
    use_highlight = TRUE,
    page_size_default = 50
  )
  
```
